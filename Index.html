<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Couples Finance Splitter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Aptos', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: #1d1d1f;
            line-height: 1.4;
            font-size: 17px;
        }

        .container {
            max-width: 980px;
            margin: 0 auto;
            background: white;
            padding: 0 22px;
        }

        .header {
            background: white;
            color: #1d1d1f;
            padding: 48px 0 32px 0;
            text-align: center;
            border-bottom: 1px solid #d2d2d7;
        }

        .header h1 {
            font-size: 48px;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: -0.003em;
        }

        .header p {
            color: #6e6e73;
            font-size: 21px;
            font-weight: 400;
            letter-spacing: 0.011em;
        }

        .main-content {
            padding: 40px 0;
        }

        .section {
            margin-bottom: 56px;
            padding: 40px 0;
            border-bottom: 1px solid #d2d2d7;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section h2 {
            color: #1d1d1f;
            margin-bottom: 32px;
            font-size: 32px;
            font-weight: 600;
            letter-spacing: -0.005em;
        }

        .form-group {
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        label {
            display: inline-block;
            margin-bottom: 0;
            margin-right: 12px;
            font-weight: 600;
            color: #1d1d1f;
            font-size: 17px;
        }

        html {
            scroll-behavior: smooth;
        }

        .section {
            scroll-margin-top: 20px;
        }

        .section.completed {
            border-left: 4px solid #0071e3;
            background: #f8f9ff;
        }

        .section.completed h2::after {
            content: " âœ“";
            color: #0071e3;
            font-weight: normal;
        }

        input,
        select,
        button {
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            background: white;
        }

        input,
        select {
            padding: 12px 16px;
            width: 75%;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #0071e3;
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
        }

        .editable-field {
            background: white !important;
            border: 2px solid #0071e3 !important;
            color: #1d1d1f !important;
            font-weight: 500 !important;
        }

        /* Categories table */
        .categories-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 24px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #d2d2d7;
        }

        .categories-table th,
        .categories-table td {
            background: #f5f5f7;
            color: #1d1d1f;
            font-weight: 600;
            text-align: left;
            border-bottom: 1px solid #d2d2d7;
            font-size: 16px;
            padding: 16px 20px;
            vertical-align: middle;
        }

        .categories-table th:nth-child(1) {
            width: 25%;
        }

        .categories-table th:nth-child(2) {
            width: 40%;
        }

        .categories-table th:nth-child(3) {
            width: 15%;
        }

        .categories-table th:nth-child(4) {
            width: 15%;
        }

        .categories-table th:nth-child(5) {
            width: 5%;
        }

        .categories-table tr:last-child td {
            border-bottom: none;
        }

        .categories-table tr:hover {
            background: #fbfbfb;
        }

        .categories-table tr.from-csv {
            background: #f0f9ff;
        }

        .categories-table tr.uncategorized-row {
            background: #f9f9f9;
        }

        .category-name-cell {
            font-weight: 600;
            color: #1d1d1f;
            font-size: 14px;
        }

        /* Slider controls */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
        }

        .quick-select-btn {
            background: #f5f5f7;
            border: 2px solid #0071e3;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 35px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            color: #1d1d1f;
        }

        .quick-select-btn:hover {
            background: #afd7ff;
        }

        .quick-select-btn:active {
            background: #0071e3;
        }

        .percentage-slider {
            flex: 1;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .percentage-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #0071e3;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .percentage-slider::-webkit-slider-thumb:hover {
            width: 20px;
            height: 20px;
            background: #005bb5;
        }

        .percentage-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #0071e3;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .percentage-slider::-moz-range-thumb:hover {
            width: 20px;
            height: 20px;
            background: #005bb5;
        }

        .percentage-display {
            background-color: #f5f5f7;
            color: #1d1d1f;
            font-weight: 500;
            text-align: center;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            min-width: 50px;
            border: 1px solid #e0e0e0;
        }

        .remove-btn-table {
            background: none;
            border: none;
            color: grey;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            transition: color 0.2s ease;
            border-radius: 4px;
        }

        .remove-btn-table:hover {
            color: red;
            background: #ffebee;
        }

        /* Transactions table */
        .transactions-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 24px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #d2d2d7;
        }

        .transactions-table th,
        .transactions-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #f5f5f7;
            font-size: 14px;
        }

        /* Center the Partner 2 amount column (7th column) */
        .transactions-table td:nth-child(7) {
            text-align: center;
            vertical-align: middle;
        }

        .transactions-table th {
            background: #f5f5f7;
            color: #1d1d1f;
            font-weight: 600;
            border-bottom: 1px solid #d2d2d7;
        }

        .transactions-table tr:hover {
            background: #fbfbfb;
        }

        .percent-input,
        .amount-input {
            width: 70px;
            height: 30px;
            font-size: 14px;
            padding: 6px 8px;
            border-radius: 6px;
            text-align: center;
            font-weight: 500;
        }

        .readonly-amount {
            background-color: white;
            color: #1d1d1f;
            font-weight: 400;
            text-align: center;
            vertical-align: middle;
            border: 1px solid white;
            font-size: 14px;
            padding: 12px 16px;
        }

        .category-select {
            width: 120px;
            font-size: 14px;
            padding: 6px 8px;
            border-radius: 8px;
        }

        .uncategorized-category {
            border: 2px solid #ef4444 !important;
            background-color: #fef2f2 !important;
        }

        .partial-match-category {
            border: 2px solid #f59e0b !important;
            background-color: #fffbeb !important;
        }

        .partial-match-category:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }

        .transactions-table+.transactions-table {
            margin-top: 0;
        }

        #creditsTable {
            border: 1px solid #d2d2d7;
        }

        #expensesTable {
            border: 1px solid #d2d2d7;
        }

        #creditsTable thead th {
            background: #f9fafb;
            color: #374151;
        }

        #expensesTable thead th {
            background: #f9fafb;
            color: #374151;
        }

        /* Ensure both transaction tables have identical dimensions */
        #expensesTable,
        #creditsTable {
            table-layout: fixed;
            width: 100%;
        }

        /* Date */
        #expensesTable th:nth-child(1),
        #creditsTable th:nth-child(1) {
            width: 10%;
        }

        /* Vendor */
        #expensesTable th:nth-child(2),
        #creditsTable th:nth-child(2) {
            width: 25%;
        }

        /* Category */
        #expensesTable th:nth-child(3),
        #creditsTable th:nth-child(3) {
            width: 15%;
        }

        /* Amount */
        #expensesTable th:nth-child(4),
        #creditsTable th:nth-child(4) {
            width: 10%;
        }

        /* Partner 1 % */
        #expensesTable th:nth-child(5),
        #creditsTable th:nth-child(5) {
            width: 10%;
        }

        /* Partner 1 Amount */
        #expensesTable th:nth-child(6),
        #creditsTable th:nth-child(6) {
            width: 10%;
        }

        /* Partner 2 Amount */
        #expensesTable th:nth-child(7),
        #creditsTable th:nth-child(7) {
            width: 10%;
        }

        /* Delete button */
        #expensesTable th:nth-child(8),
        #creditsTable th:nth-child(8) {
            width: 10%;
        }


        /* Ensure consistent cell alignment */
        #expensesTable td:nth-child(4),
        #creditsTable td:nth-child(4),
        #expensesTable td:nth-child(5),
        #creditsTable td:nth-child(5),
        #expensesTable td:nth-child(6),
        #creditsTable td:nth-child(6),
        #expensesTable td:nth-child(7),
        #creditsTable td:nth-child(7),
        #expensesTable td:nth-child(8),
        #creditsTable td:nth-child(8) {
            text-align: center;
        }

        button {
            background: #5ba9f7;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 400;
            padding: 12px 24px;
            border-radius: 12px;
            transition: background-color 0.15s ease-in-out;
            font-size: 17px;
        }

        button:hover {
            background: #0e78d0;
        }

        .summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 32px;
        }

        .summary-card {
            background: white;
            color: #1d1d1f;
            padding: 32px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #d2d2d7;
        }

        .summary-card h3 {
            font-size: 24px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .summary-card p {
            font-size: 36px;
            font-weight: 700;
            color: #0071e3;
        }

        .file-upload-area {
            border: 2px dashed #d2d2d7;
            padding: 48px;
            text-align: center;
            border-radius: 12px;
            background: #fbfbfd;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
        }

        .file-upload-area:hover {
            background: #f5f5f7;
            border-color: #0071e3;
        }

        .file-upload-area.dragover {
            background: #f0f9ff;
            border-color: #0071e3;
        }

        .partners-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .partner-input {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #d2d2d7;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .hidden {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #f5f5f7;
            border-radius: 2px;
            overflow: hidden;
            margin: 24px 0;
        }

        .progress-fill {
            height: 100%;
            background: #0071e3;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Make delete button smaller and match remove button styling */
.delete-btn {
    background: none;
    border: none;
    color: grey;
    font-size: 20px;
    cursor: pointer;
    padding: 4px 8px;
    transition: color 0.2s ease;
    border-radius: 4px;
}

.delete-btn:hover {
    color: red;
    background: #ffebee;
}

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Remove number input arrows */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            appearance: textfield;
        }

        .summary-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #d2d2d7;
            margin-top: 20px;
        }

        .summary-table th,
        .summary-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #f5f5f7;
            font-size: 15px;
        }

        .summary-table th {
            background: #f5f5f7;
            color: #1d1d1f;
            font-weight: 600;
            border-bottom: 1px solid #d2d2d7;
        }

        .summary-table th:nth-child(2),
        .summary-table th:nth-child(3),
        .summary-table th:nth-child(4),
        .summary-table th:nth-child(5) {
            text-align: center;
        }

        .summary-table td:nth-child(2),
        .summary-table td:nth-child(3),
        .summary-table td:nth-child(4),
        .summary-table td:nth-child(5) {
            text-align: center;
        }

        .summary-table tr:hover {
            background: #fbfbfb;
        }

        .summary-table tfoot {
            background: #f5f5f7;
        }

        .summary-total-row td {
            background: #f5f5f7 !important;
            border-top: 2px solid #d2d2d7;
            font-weight: 600;
        }

        .summary-table tr:last-child td {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }

            .header h1 {
                font-size: 32px;
            }

            .summary,
            .partners-section {
                grid-template-columns: 1fr;
            }

            .slider-container {
                gap: 8px;
            }

            .quick-select-btn {
                min-width: 30px;
                font-size: 11px;
                padding: 3px 6px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Tandem</h1>
            <p>Manage your shared expenses with ease</p>
            <p>Note: your personal information is not stored</p>
        </div>

        <div class="main-content">
            <!-- Step 1: Partner Names -->
            <div class="section">
                <h2>Step 1: Enter your names</h2>
                <div class="partners-section">
                    <div class="partner-input">
                        <label for="partner1">Partner 1</label>
                        <input type="text" id="partner1" placeholder="Enter name" class="editable-field">
                    </div>
                    <div class="partner-input">
                        <label for="partner2">Partner 2</label>
                        <input type="text" id="partner2" placeholder="Enter name" class="editable-field">
                    </div>
                </div>
            </div>

            <!-- Step 2: File Upload -->
            <div class="section">
                <h2>Step 2: Upload bank or credit card statement</h2>
                <div class="file-upload-area" id="fileUpload">
                    <p>Drag & drop your CSV statement here or click to select</p>
                    <input type="file" id="fileInput" accept=".csv" style="display: none;">
                </div>
                <div class="progress-bar hidden" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p style="margin-top: 10px; color: #666;">Supported formats: CSV only</p>
            </div>

            <!-- Step 3: Category Setup -->
            <div class="section hidden" id="categorySection">
                <h2>Step 3: Review and adjust spending categories</h2>

                <table class="categories-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Split Adjustment</th>
                            <th id="partner1Header">Partner 1</th>
                            <th id="partner2Header">Partner 2</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="categories-tbody"></tbody>
                </table>

                <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #d2d2d7;">
                    <div class="form-group">
                        <label for="categorySelect">Add category</label>
                        <select id="categorySelect" onchange="handleCategorySelection()">
                            <option value="">Select a category...</option>
                            <option value="Dining Out">Dining Out</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Gas">Gas</option>
                            <option value="Groceries">Groceries</option>
                            <option value="Health/Medical">Health/Medical</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Personal Care">Personal Care</option>
                            <option value="Pet Care">Pet Care</option>
                            <option value="Phone/Internet">Phone/Internet</option>
                            <option value="Rent/Mortgage">Rent/Mortgage</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Subscriptions">Subscriptions</option>
                            <option value="Transportation">Transportation</option>
                            <option value="Travel">Travel</option>
                            <option value="Utilities">Utilities</option>
                            <option value="custom">Custom...</option>
                        </select>
                        <button type="button" onclick="addCategory()" id="addCategoryBtn">Add</button>
                    </div>
                    <div class="form-group hidden" id="customCategoryGroup">
                        <label for="customCategory">Category name</label>
                        <input type="text" id="customCategory" placeholder="Enter custom category name"
                            oninput="toggleConfirmButton()">
                        <button type="button" onclick="confirmCustomCategory()" id="confirmCustomBtn" class="hidden"
                            style="margin-left: 12px;">Confirm</button>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 32px;">
                    <button type="button" onclick="proceedToTransactionReview()">
                        Continue to Transaction Review
                    </button>
                </div>
            </div>

            <!-- Step 4: Transaction Review -->
            <div class="section hidden" id="transactionSection">
                <h2>Step 4: Review & modify transactions</h2>

                <!-- Expenses Table -->
                <div style="margin-bottom: 40px;">
                    <h3 style="color: #374151; margin-bottom: 15px;">Expenses & Charges</h3>
                    <table class="transactions-table" id="expensesTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Vendor</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Partner 1's %</th>
                                <th>Partner 1's Amount</th>
                                <th>Partner 2's Amount</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="expensesBody"></tbody>
                    </table>
                </div>

                <!-- Credits Table -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #374151; margin-bottom: 15px;">Credits & Refunds</h3>
                    <table class="transactions-table" id="creditsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Vendor</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Partner 1's %</th>
                                <th>Partner 1's Amount</th>
                                <th>Partner 2's Amount</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="creditsBody"></tbody>
                    </table>
                    <div id="noCreditsMessage"
                        style="text-align: center; padding: 20px; color: #6e6e73; font-style: italic; display: none;">
                        No credits or refunds found in this statement.
                    </div>
                </div>

                <button type="button" onclick="calculateSplit()" style="margin-top: 20px; width: 100%;">
                    Calculate Split
                </button>
            </div>

            <!-- Step 5: Summary -->
            <div class=" section hidden" id="summarySection">
                <h2>Step 5: View & export summary</h2>

                <!-- Overall Summary Cards -->
                <div class="summary">
                    <div class="summary-card">
                        <h3 id="partner1Summary">Partner 1</h3>
                        <p id="partner1Amount">$0.00</p>
                    </div>
                    <div class="summary-card">
                        <h3 id="partner2Summary">Partner 2</h3>
                        <p id="partner2Amount">$0.00</p>
                    </div>
                </div>

                <div
                    style="margin-top: 20px; padding: 20px; background: white; border-radius: 8px; text-align: center;">
                    <h3>Total Shared Expenses: <span id="totalAmount">$0.00</span></h3>
                </div>

                <!-- Detailed Breakdown Table -->
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 20px;">Detailed Breakdown by Category</h3>
                    <table class="summary-table" id="summaryTable">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Total Amount</th>
                                <th>% of Total</th>
                                <th id="partner1SummaryHeader">Partner 1</th>
                                <th id="partner2SummaryHeader">Partner 2</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTableBody">
                            <!-- Summary rows will be populated here -->
                        </tbody>
                        <tfoot>
                            <tr class="summary-total-row">
                                <td><strong>TOTAL</strong></td>
                                <td id="summaryTotalAmount"><strong>$0.00</strong></td>
                                <td><strong>100%</strong></td>
                                <td id="summaryPartner1Total"><strong>$0.00</strong></td>
                                <td id="summaryPartner2Total"><strong>$0.00</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 8px;">
                    <div style="text-align: center; margin-top: 15px;">
                        <button type="button" onclick="exportCompleteReport()">
                            Export Your Summary
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let transactions = [];
        let categories = {};
        let discoveredCategories = new Set();
        let isManualCategoryUpdate = false;
        let isSliderUpdate = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            setupFileUpload();
            setupPartnerNameUpdates();
        });
        function scrollToSection(sectionId) {
    console.log('scrollToSection called with:', sectionId);
    const section = document.getElementById(sectionId);
    if (section) {
        console.log('Section found, scrolling...');
        section.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start',
            inline: 'nearest'
        });
    } else {
        console.error('Section not found:', sectionId);
    }
}
        function setupPartnerNameUpdates() {
            const partner1Input = document.getElementById('partner1');
            const partner2Input = document.getElementById('partner2');

            partner1Input.addEventListener('input', updatePartnerNamesInCategories);
            partner2Input.addEventListener('input', updatePartnerNamesInCategories);
            partner1Input.addEventListener('input', updateTransactionHeaders);
            partner2Input.addEventListener('input', updateTransactionHeaders);
        }

        function updateTransactionHeaders() {
            const partner1Name = document.getElementById('partner1').value || 'Partner 1';
            const partner2Name = document.getElementById('partner2').value || 'Partner 2';
            const partner1Possessive = partner1Name.endsWith('s') ? `${partner1Name}'` : `${partner1Name}'s`;
            const partner2Possessive = partner2Name.endsWith('s') ? `${partner2Name}'` : `${partner2Name}'s`;

            const headerRow = document.querySelector('#transactionsTable thead tr');
            if (headerRow) {
                const headers = headerRow.querySelectorAll('th');
                if (headers.length >= 7) {
                    headers[4].textContent = `${partner1Possessive} %`;
                    headers[5].textContent = `${partner1Possessive} Amount`;
                    headers[6].textContent = `${partner2Possessive} Amount`;
                }
            }
        }

        function updatePartnerNamesInCategories() {
            const partner1Name = document.getElementById('partner1').value || 'Partner 1';
            const partner2Name = document.getElementById('partner2').value || 'Partner 2';

            const partner1Header = document.getElementById('partner1Header');
            const partner2Header = document.getElementById('partner2Header');
            if (partner1Header) partner1Header.textContent = partner1Name;
            if (partner2Header) partner2Header.textContent = partner2Name;
        }

        // File upload setup - CSV only
        function setupFileUpload() {
            const fileUpload = document.getElementById('fileUpload');
            const fileInput = document.getElementById('fileInput');

            // Simple click handler
            fileUpload.onclick = function () {
                console.log('Upload area clicked, opening file dialog'); // Debug
                fileInput.click();
            };

            fileUpload.ondragover = function (e) {
                e.preventDefault();
                fileUpload.classList.add('dragover');
            };

            fileUpload.ondragleave = function () {
                fileUpload.classList.remove('dragover');
            };

            fileUpload.ondrop = function (e) {
                e.preventDefault();
                fileUpload.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                console.log('File dropped:', file); // Debug
                if (file) {
                    handleFile(file);
                }
            };

            fileInput.onchange = function (e) {
                const file = e.target.files[0];
                console.log('File selected:', file); // Debug
                if (file) {
                    handleFile(file);
                }
                // Reset the input
                this.value = '';
            };
        }

        function handleFile(file) {
            if (!file) return;

            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');

            progressBar.classList.remove('hidden');
            progressFill.style.width = '0%';

            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                progressFill.style.width = progress + '%';
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    setTimeout(() => {
                        progressBar.classList.add('hidden');
                        processFile(file);
                    }, 500);
                }
            }, 100);
        }

        // Updated file processing - CSV only
        function processFile(file) {
            const fileType = file.type;
            const fileName = file.name.toLowerCase();

            if (fileType === 'text/csv' || fileName.endsWith('.csv')) {
                processCSV(file);
            } else {
                alert('Only CSV files are supported. Please upload a CSV file.');
            }
        }

        function processCSV(file) {
            console.log('Processing CSV file:', file.name, 'Size:', file.size);
            const reader = new FileReader();
            reader.onload = function (e) {
                console.log('File read successfully, content length:', e.target.result.length);
                console.log('First 500 characters:', e.target.result.substring(0, 500));
                parseTransactions(e.target.result);
            };
            reader.onerror = function (e) {
                console.error('Error reading file:', e);
                alert('Error reading the CSV file. Please try again.');
            };
            reader.readAsText(file);
        }

        function parseTransactions(text) {
            transactions = [];
            discoveredCategories.clear();

            const lines = text.split('\n');
            let isFirstLine = true;
            let headerMapping = null;

            lines.forEach((line) => {
                if (!line.trim()) return;

                if (isFirstLine && line.includes(',')) {
                    headerMapping = mapCSVHeaders(line);
                    isFirstLine = false;
                    return;
                }
                isFirstLine = false;

                if (line.includes(',')) {
                    const columns = line.split(',').map(col => col.trim().replace(/"/g, ''));

                    let dateCol = -1, descCol = -1, amountCol = -1, categoryCol = -1;

                    if (headerMapping) {
                        dateCol = headerMapping.date;
                        descCol = headerMapping.description;
                        amountCol = headerMapping.amount;
                        categoryCol = headerMapping.category;
                    } else {
                        // Auto-detect columns
                        for (let i = 0; i < columns.length; i++) {
                            const col = columns[i];
                            if (dateCol === -1 && /\d{1,2}\/\d{1,2}\/\d{4}|\d{4}-\d{2}-\d{2}/.test(col)) {
                                dateCol = i;
                            }
                            if (/[\$]?\d+\.\d{2}/.test(col)) {
                                amountCol = i;
                            }
                        }

                        if (dateCol !== -1 && amountCol !== -1) {
                            for (let i = 0; i < columns.length; i++) {
                                if (i !== dateCol && i !== amountCol && columns[i].length > 3) {
                                    descCol = i;
                                    break;
                                }
                            }
                        }
                    }

                    if (dateCol !== -1 && amountCol !== -1 && descCol !== -1) {
                        const date = columns[dateCol];
                        const description = columns[descCol];
                        const amountStr = columns[amountCol].replace(/[,\$\(\)]/g, '');
                        const amount = parseFloat(amountStr); // Remove Math.abs() to preserve sign
                        const creditCardCategory = categoryCol !== -1 ? columns[categoryCol] : null;

                        if (description && amount !== 0) { // Changed from amount > 0 to amount !== 0
                            const category = enhancedCategorizeTransaction(description, creditCardCategory);
                            discoveredCategories.add(category);

                            transactions.push({
                                date,
                                description,
                                amount,
                                category,
                                partner1Percent: 50,
                                partner2Percent: 50,
                                manuallyEdited: false
                            });
                        }
                    }
                }
            });

            if (transactions.length === 0) {
                // Sample data for testing
                transactions = [
                    { date: '2024-01-15', description: 'Whole Foods Market', amount: 145.67, category: 'Groceries', partner1Percent: 50, partner2Percent: 50, manuallyEdited: false },
                    { date: '2024-01-16', description: 'Olive Garden Restaurant', amount: 78.50, category: 'Dining Out', partner1Percent: 50, partner2Percent: 50, manuallyEdited: false },
                    { date: '2024-01-17', description: 'Pacific Gas & Electric', amount: 120.00, category: 'Utilities', partner1Percent: 50, partner2Percent: 50, manuallyEdited: false }
                ];
                transactions.forEach(t => discoveredCategories.add(t.category));
            }

            transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            showCategorySection();
        }

        function mapCSVHeaders(headerLine) {
            const headers = headerLine.toLowerCase().split(',').map(h => h.trim().replace(/"/g, ''));
            const mapping = { date: -1, description: -1, amount: -1, category: -1 };

            headers.forEach((header, index) => {
                if (header.includes('date')) mapping.date = index;
                else if (header.includes('description') || header.includes('merchant')) mapping.description = index;
                else if (header.includes('amount') || header.includes('debit')) mapping.amount = index;
                else if (header.includes('category')) mapping.category = index;
            });

            return mapping;
        }

        function enhancedCategorizeTransaction(description, creditCardCategory) {
            if (creditCardCategory) {
                const mapped = mapCreditCardCategory(creditCardCategory);
                if (mapped) return mapped;
            }
            return categorizeTransaction(description);
        }

        function mapCreditCardCategory(category) {
            const cat = category.toLowerCase().trim();

            // Grocery mapping
            if (cat.includes('grocery') || cat.includes('supermarket') || cat.includes('food store') ||
                cat.includes('market') || cat.includes('food & beverage')) return 'Groceries';

            // Dining mapping
            if (cat.includes('restaurant') || cat.includes('dining') || cat.includes('food') ||
                cat.includes('cafe') || cat.includes('coffee') || cat.includes('fast food') ||
                cat.includes('bar') || cat.includes('takeout') || cat.includes('delivery')) return 'Dining Out';

            // Transportation mapping
            if (cat.includes('gas') || cat.includes('fuel') || cat.includes('automotive') ||
                cat.includes('transportation') || cat.includes('parking') || cat.includes('uber') ||
                cat.includes('lyft') || cat.includes('taxi') || cat.includes('rideshare')) return 'Transportation';

            // Utilities mapping
            if (cat.includes('utilities') || cat.includes('electric') || cat.includes('gas bill') ||
                cat.includes('water') || cat.includes('internet') || cat.includes('phone') ||
                cat.includes('cable') || cat.includes('wireless')) return 'Utilities';

            // Entertainment mapping
            if (cat.includes('entertainment') || cat.includes('movie') || cat.includes('streaming') ||
                cat.includes('music') || cat.includes('gaming') || cat.includes('subscription')) return 'Entertainment';

            // Shopping mapping
            if (cat.includes('shopping') || cat.includes('retail') || cat.includes('department store') ||
                cat.includes('clothing') || cat.includes('merchandise')) return 'Shopping';

            // Health/Medical mapping
            if (cat.includes('health') || cat.includes('medical') || cat.includes('pharmacy') ||
                cat.includes('doctor') || cat.includes('hospital') || cat.includes('dental')) return 'Health/Medical';

            // Travel mapping
            if (cat.includes('travel') || cat.includes('airline') || cat.includes('hotel') ||
                cat.includes('lodging') || cat.includes('rental car')) return 'Travel';

            return null;
        }

        function categorizeTransaction(description) {
            const desc = description.toLowerCase().trim();

            // Comprehensive categorization patterns
            const categories = {
                'Groceries': {
                    stores: ['whole foods', 'safeway', 'kroger', 'walmart', 'target', 'costco', 'sams club',
                        'trader joe', 'albertsons', 'publix', 'wegmans', 'stop shop', 'giant', 'harris teeter',
                        'food lion', 'meijer', 'hy-vee', 'winco', 'fred meyer', 'king soopers', 'smiths',
                        'ralphs', 'vons', 'pavilions', 'randalls', 'tom thumb', 'star market', 'shaws',
                        'acme', 'jewel-osco', 'dominicks', 'marianos', 'fresh market', 'sprouts'],
                    keywords: ['grocery', 'supermarket', 'market', 'food store', 'produce', 'fresh']
                },
                'Dining Out': {
                    chains: ['mcdonalds', 'burger king', 'wendys', 'taco bell', 'kfc', 'pizza hut', 'dominos',
                        'subway', 'starbucks', 'dunkin', 'chipotle', 'panera', 'olive garden', 'applebees',
                        'chilis', 'outback', 'red lobster', 'texas roadhouse', 'chick-fil-a', 'five guys',
                        'in-n-out', 'shake shack', 'sonic', 'dairy queen', 'arbys', 'popeyes', 'panda express',
                        'qdoba', 'moes', 'jimmy johns', 'papa johns', 'little caesars', 'papa murphys',
                        'pizza ranch', 'godfather', 'casey', 'culvers', 'whataburger', 'jack in the box',
                        'carls jr', 'hardees', 'white castle', 'krystal', 'waffle house', 'ihop', 'dennys',
                        'cracker barrel', 'bob evans', 'perkins', 'friendly', 'hooters', 'twin peaks',
                        'buffalo wild wings', 'wing stop', 'pizza', 'coffee', 'cafe', 'bistro', 'grill'],
                    keywords: ['restaurant', 'dining', 'eatery', 'food', 'lunch', 'dinner', 'breakfast',
                        'takeout', 'delivery', 'drive-thru', 'fast food', 'dine-in', 'bar', 'pub',
                        'tavern', 'brewing', 'brewery', 'coffee shop', 'tea house']
                },
                'Transportation': {
                    gas: ['shell', 'exxon', 'mobil', 'chevron', 'bp', 'citgo', 'sunoco', 'marathon', 'speedway',
                        'wawa', 'sheetz', 'casey', 'kwik trip', 'holiday', 'maverik', 'pilot', 'loves',
                        'flying j', 'ta travel', 'petro', '76', 'conoco', 'phillips 66', 'valero', 'arco',
                        'gulf', 'amoco', 'sinclair', 'murphy'],
                    rideshare: ['uber', 'lyft', 'taxi', 'cab', 'rideshare', 'lime', 'bird', 'scooter'],
                    parking: ['parking', 'meter', 'garage', 'lot', 'park'],
                    keywords: ['gas station', 'fuel', 'gasoline', 'diesel', 'transportation', 'transit',
                        'bus', 'train', 'subway', 'metro', 'toll', 'bridge', 'tunnel']
                },
                'Utilities': {
                    companies: ['pge', 'pg&e', 'pacific gas', 'edison', 'sce', 'sdge', 'xcel', 'duke energy',
                        'florida power', 'georgia power', 'alabama power', 'mississippi power',
                        'entergy', 'oncor', 'centerpoint', 'aps', 'srp', 'dte', 'consumers energy',
                        'pepco', 'bge', 'peco', 'ppl', 'pseg', 'con edison', 'national grid',
                        'eversource', 'unitil', 'liberty', 'avangrid', 'dominion', 'appalachian power'],
                    keywords: ['electric', 'electricity', 'power', 'energy', 'gas bill', 'water', 'sewer',
                        'waste', 'trash', 'recycling', 'utility', 'utilities']
                },
                'Phone/Internet': {
                    providers: ['verizon', 'att', 'at&t', 't-mobile', 'tmobile', 'sprint', 'comcast', 'xfinity',
                        'spectrum', 'cox', 'optimum', 'frontier', 'centurylink', 'windstream',
                        'mediacom', 'suddenlink', 'wow', 'rcn', 'astound', 'metronet', 'google fiber',
                        'fios', 'uverse', 'directv', 'dish', 'sling', 'youtube tv', 'hulu live'],
                    keywords: ['wireless', 'cellular', 'phone', 'internet', 'broadband', 'cable', 'fiber',
                        'wifi', 'data', 'mobile', 'telecom', 'isp']
                },
                'Entertainment': {
                    streaming: ['netflix', 'hulu', 'disney+', 'disney plus', 'amazon prime', 'hbo max', 'hbo',
                        'paramount+', 'peacock', 'apple tv', 'youtube premium', 'spotify', 'apple music',
                        'pandora', 'tidal', 'amazon music', 'google play music', 'sirius', 'siriusxm'],
                    venues: ['amc', 'regal', 'cinemark', 'movie', 'theater', 'cinema', 'imax', 'concert',
                        'venue', 'stadium', 'arena', 'auditorium', 'bowling', 'arcade', 'dave busters',
                        'top golf', 'mini golf', 'laser tag', 'escape room'],
                    keywords: ['entertainment', 'music', 'video', 'game', 'gaming', 'subscription',
                        'streaming', 'premium', 'plus', 'pro', 'membership']
                },
                'Shopping': {
                    stores: ['amazon', 'ebay', 'walmart', 'target', 'best buy', 'home depot', 'lowes', 'costco',
                        'sams club', 'bjs', 'macys', 'nordstrom', 'kohls', 'jcpenney', 'sears', 'tj maxx',
                        'marshalls', 'ross', 'burlington', 'old navy', 'gap', 'banana republic',
                        'american eagle', 'abercrombie', 'hollister', 'forever 21', 'h&m', 'zara',
                        'uniqlo', 'urban outfitters', 'anthropologie', 'free people', 'lululemon',
                        'nike', 'adidas', 'foot locker', 'dick sporting goods', 'sports authority',
                        'bed bath beyond', 'williams sonoma', 'pottery barn', 'crate barrel', 'ikea',
                        'wayfair', 'overstock', 'world market', 'pier 1', 'hobby lobby', 'michaels',
                        'jo-ann', 'fabric', 'cvs', 'walgreens', 'rite aid'],
                    keywords: ['shopping', 'retail', 'store', 'shop', 'mall', 'outlet', 'marketplace',
                        'purchase', 'buy', 'clothing', 'apparel', 'shoes', 'accessories', 'electronics',
                        'home goods', 'furniture', 'decor', 'garden', 'sporting goods', 'toys']
                },
                'Health/Medical': {
                    providers: ['cvs', 'walgreens', 'rite aid', 'pharmacy', 'kaiser', 'blue cross', 'aetna',
                        'humana', 'cigna', 'unitedhealth', 'anthem', 'medical', 'health', 'hospital',
                        'clinic', 'urgent care', 'minute clinic', 'lab corp', 'quest'],
                    keywords: ['medical', 'health', 'doctor', 'physician', 'dentist', 'dental', 'orthodontist',
                        'optometrist', 'eye', 'vision', 'pharmacy', 'prescription', 'rx', 'copay',
                        'deductible', 'insurance', 'wellness', 'fitness', 'therapy', 'physical therapy',
                        'mental health', 'counseling', 'psychiatrist', 'psychologist']
                },
                'Travel': {
                    airlines: ['american', 'delta', 'united', 'southwest', 'jetblue', 'alaska', 'frontier',
                        'spirit', 'allegiant', 'sun country', 'hawaiian'],
                    hotels: ['marriott', 'hilton', 'hyatt', 'sheraton', 'westin', 'doubletree', 'embassy',
                        'hampton', 'holiday inn', 'best western', 'comfort inn', 'quality inn',
                        'super 8', 'motel 6', 'la quinta', 'days inn', 'ramada', 'howard johnson',
                        'red roof', 'extended stay', 'residence inn', 'homewood', 'airbnb', 'vrbo'],
                    rental: ['hertz', 'avis', 'enterprise', 'budget', 'alamo', 'national', 'dollar', 'thrifty',
                        'sixt', 'zipcar', 'turo'],
                    keywords: ['airline', 'flight', 'airport', 'hotel', 'motel', 'resort', 'lodge', 'inn',
                        'rental car', 'car rental', 'travel', 'vacation', 'trip', 'cruise', 'tour']
                },
                'Insurance': {
                    companies: ['state farm', 'geico', 'progressive', 'allstate', 'farmers', 'usaa', 'liberty mutual',
                        'nationwide', 'american family', 'auto-owners', 'erie', 'country financial',
                        'shelter', 'amica', 'encompass', 'safeco', 'general', 'metlife', 'prudential',
                        'new york life', 'northwestern mutual', 'mass mutual', 'john hancock'],
                    keywords: ['insurance', 'premium', 'policy', 'coverage', 'auto insurance', 'car insurance',
                        'home insurance', 'renters insurance', 'life insurance', 'health insurance']
                },
                'Subscriptions': {
                    services: ['netflix', 'hulu', 'disney+', 'hbo max', 'amazon prime', 'spotify', 'apple music',
                        'youtube premium', 'adobe', 'microsoft 365', 'office 365', 'google workspace',
                        'dropbox', 'icloud', 'onedrive', 'zoom', 'slack', 'github', 'linkedin premium',
                        'new york times', 'wall street journal', 'washington post', 'medium', 'substack'],
                    keywords: ['subscription', 'monthly', 'annual', 'premium', 'plus', 'pro', 'membership',
                        'recurring', 'auto-renew', 'digital', 'online', 'cloud', 'software']
                },
                'Personal Care': {
                    stores: ['sephora', 'ulta', 'sally beauty', 'great clips', 'supercuts', 'sport clips',
                        'fantastic sams', 'cost cutters', 'hair cuttery', 'regis', 'smartstyle',
                        'massage envy', 'hand and stone', 'elements', 'spa'],
                    keywords: ['salon', 'barbershop', 'hair', 'nails', 'massage', 'spa', 'beauty',
                        'cosmetics', 'skincare', 'personal care', 'grooming', 'facial', 'manicure',
                        'pedicure', 'waxing', 'threading', 'eyebrow', 'lashes']
                },
                'Pet Care': {
                    stores: ['petco', 'petsmart', 'pet supplies plus', 'tractor supply', 'rural king',
                        'farm fleet', 'fleet farm', 'chewy'],
                    keywords: ['pet', 'dog', 'cat', 'animal', 'vet', 'veterinary', 'grooming', 'boarding',
                        'daycare', 'food', 'supplies', 'toys', 'treats', 'litter', 'collar', 'leash']
                }
            };

            // Check each category
            for (const [categoryName, patterns] of Object.entries(categories)) {
                // Check stores/companies/services
                for (const patternType of ['stores', 'chains', 'gas', 'rideshare', 'companies', 'providers', 'venues', 'streaming', 'airlines', 'hotels', 'rental', 'services']) {
                    if (patterns[patternType]) {
                        for (const item of patterns[patternType]) {
                            if (desc.includes(item)) {
                                return categoryName;
                            }
                        }
                    }
                }

                // Check keywords
                if (patterns.keywords) {
                    for (const keyword of patterns.keywords) {
                        if (desc.includes(keyword)) {
                            return categoryName;
                        }
                    }
                }
            }

            return 'Uncategorized (Default)';
        }

        function showCategorySection() {
            initializeCategoriesFromData();
            document.getElementById('categorySection').classList.remove('hidden');

            // Auto-scroll to category section
            setTimeout(() => {
                scrollToSection('categorySection');
            }, 100);
        }

        function initializeCategoriesFromData() {
            const tbody = document.getElementById('categories-tbody');
            tbody.innerHTML = '';
            categories = {};

            const filteredCategories = Array.from(discoveredCategories).filter(cat =>
                cat !== 'Uncategorized (Default)' && cat !== 'Uncategorized'
            );

            filteredCategories.sort().forEach(category => {
                addCategoryRowToTable(category);
            });

            addUncategorizedDefaultToTable();
            updateCommonCategoryDropdown();
        }

        function addCategoryRowToTable(categoryName, isDefault = false) {
            const tbody = document.getElementById('categories-tbody');
            const row = document.createElement('tr');

            if (!isDefault) {
                row.className = 'from-csv';
            } else {
                row.className = 'uncategorized-row';
            }

            row.innerHTML = `
                <td class="category-name-cell">${categoryName}</td>
                <td>
                    <div class="slider-container">
                        <button type="button" class="quick-select-btn" onclick="adjustSlider(this, -25)">-25%</button>
                        <input type="range" class="percentage-slider" min="0" max="100" value="50" 
                               onchange="updatePercentageFromSlider(this)" oninput="updatePercentageFromSlider(this)">
                        <button type="button" class="quick-select-btn" onclick="adjustSlider(this, 25)">+25%</button>
                    </div>
                </td>
                <td style="text-align: center;">
                    <div class="percentage-display">50%</div>
                </td>
                <td style="text-align: center;">
                    <div class="percentage-display">50%</div>
                </td>
                <td style="text-align: center;">
                    ${isDefault ? '' : '<button type="button" class="remove-btn-table" onclick="removeCategoryFromTable(this)">&times;</button>'}
                </td>
            `;

            tbody.appendChild(row);

            categories[categoryName] = {
                partner1: 50,
                partner2: 50
            };
        }

        function adjustSlider(button, adjustment) {
            isSliderUpdate = true; // Set flag to prevent auto-scroll

            const row = button.closest('tr');
            const slider = row.querySelector('.percentage-slider');
            let currentValue = parseInt(slider.value);
            let newValue = currentValue + adjustment;

            // Clamp the value between 0 and 100
            newValue = Math.max(0, Math.min(100, newValue));

            slider.value = newValue;
            updatePercentageFromSlider(slider);

            isSliderUpdate = false; // Reset flag
        }

        function updatePercentageFromSlider(slider) {
            // Don't set flag here if it's already set by adjustSlider
            if (!isSliderUpdate) {
                isSliderUpdate = true;
            }

            const row = slider.closest('tr');
            const partner1Value = parseInt(slider.value);
            const partner2Value = 100 - partner1Value;

            const partner1Display = row.children[2].querySelector('.percentage-display');
            const partner2Display = row.children[3].querySelector('.percentage-display');

            partner1Display.textContent = `${partner1Value}%`;
            partner2Display.textContent = `${partner2Value}%`;

            updateCategoriesAndRefresh();

            // Reset flag only if we set it in this function
            if (isSliderUpdate) {
                isSliderUpdate = false;
            }
        }

        function addUncategorizedDefaultToTable() {
            addCategoryRowToTable('Uncategorized (Default)', true);
        }

        function updateCommonCategoryDropdown() {
            const select = document.getElementById('categorySelect');
            const currentCategories = new Set();

            const categoryRows = document.querySelectorAll('#categories-tbody tr');
            categoryRows.forEach(row => {
                const nameCell = row.querySelector('.category-name-cell');
                if (nameCell) {
                    currentCategories.add(nameCell.textContent.trim());
                }
            });

            const allCategories = [
                'Groceries', 'Dining Out', 'Utilities', 'Rent/Mortgage', 'Transportation',
                'Entertainment', 'Health/Medical', 'Shopping', 'Travel', 'Insurance',
                'Phone/Internet', 'Subscriptions', 'Gas', 'Personal Care', 'Pet Care', 'Other'
            ];

            const availableCategories = allCategories
                .filter(category => !currentCategories.has(category))
                .sort();

            // Store current selection to preserve "custom" state
            const currentValue = select.value;

            select.innerHTML = '<option value="">Select a category...</option>';

            availableCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });

            // Always add the custom option
            const customOption = document.createElement('option');
            customOption.value = 'custom';
            customOption.textContent = 'Custom...';
            select.appendChild(customOption);

            // Restore selection if it was custom
            if (currentValue === 'custom') {
                select.value = 'custom';
                document.getElementById('customCategoryGroup').classList.remove('hidden');
            }
        }
        function toggleConfirmButton() {
            const customInput = document.getElementById('customCategory');
            const confirmBtn = document.getElementById('confirmCustomBtn');

            if (customInput.value.trim().length > 0) {
                confirmBtn.classList.remove('hidden');
            } else {
                confirmBtn.classList.add('hidden');
            }
        }

        function confirmCustomCategory() {
            const customInput = document.getElementById('customCategory');
            const categoryName = customInput.value.trim();

            if (!categoryName) {
                alert('Please enter a custom category name.');
                customInput.focus();
                return;
            }

            if (findExistingCategory(categoryName)) {
                alert('This category already exists.');
                return;
            }

            addCategoryRowToTable(categoryName);

            // Reset the form
            const select = document.getElementById('categorySelect');
            const customGroup = document.getElementById('customCategoryGroup');
            const confirmBtn = document.getElementById('confirmCustomBtn');

            select.value = '';
            customInput.value = '';
            customGroup.classList.add('hidden');
            confirmBtn.classList.add('hidden');

            updateCommonCategoryDropdown();
            updateTransactionCategoryDropdowns();
        }
        function handleCategorySelection() {
            const select = document.getElementById('categorySelect');
            const customGroup = document.getElementById('customCategoryGroup');
            const customInput = document.getElementById('customCategory');
            const confirmBtn = document.getElementById('confirmCustomBtn');

            if (select.value === 'custom') {
                customGroup.classList.remove('hidden');
                customInput.focus();
            } else {
                customGroup.classList.add('hidden');
                customInput.value = '';
                confirmBtn.classList.add('hidden');
            }
        }

        function addCategory() {
            const select = document.getElementById('categorySelect');

            if (select.value === 'custom') {
                // For custom categories, user should use the confirm button
                alert('Please enter a custom category name and click "Confirm custom category".');
                return;
            } else if (select.value) {
                // Handle common categories
                const categoryName = select.value;

                if (findExistingCategory(categoryName)) {
                    alert('This category already exists.');
                    return;
                }

                addCategoryRowToTable(categoryName);

                // Reset the form
                select.value = '';

                updateCommonCategoryDropdown();
                updateTransactionCategoryDropdowns();
            } else {
                alert('Please select a category.');
                return;
            }
        }

        function removeCategoryFromTable(button) {
            const row = button.closest('tr');
            row.remove();
            updateCategories();
            updateCommonCategoryDropdown();
            updateTransactionCategoryDropdowns();
        }

        function findExistingCategory(categoryName) {
            const categoryRows = document.querySelectorAll('#categories-tbody tr');
            const normalizedInput = categoryName.toLowerCase().trim();

            for (const row of categoryRows) {
                const nameCell = row.querySelector('.category-name-cell');
                if (!nameCell) continue;

                const existingName = nameCell.textContent.trim();
                const normalizedExisting = existingName.toLowerCase().trim();

                if (normalizedExisting === normalizedInput) {
                    return existingName;
                }
            }
            return null;
        }

        function updateCategories() {
            categories = {};
            const categoryRows = document.querySelectorAll('#categories-tbody tr');
            categoryRows.forEach(row => {
                const nameCell = row.querySelector('.category-name-cell');
                const slider = row.querySelector('.percentage-slider');
                const name = nameCell.textContent;
                const partner1Percent = parseFloat(slider.value) || 0;
                const partner2Percent = 100 - partner1Percent;

                if (name) {
                    categories[name] = {
                        partner1: partner1Percent,
                        partner2: partner2Percent
                    };
                }
            });
        }

        function updateCategoriesAndRefresh() {
            updateCategories();

            if (transactions.length > 0) {
                transactions.forEach(transaction => {
                    if (!transaction.manuallyEdited) {
                        const categoryData = categories[transaction.category] || categories['Uncategorized (Default)'];
                        if (categoryData) {
                            transaction.partner1Percent = categoryData.partner1;
                            transaction.partner2Percent = categoryData.partner2;
                        }
                    }
                });

                const transactionSection = document.getElementById('transactionSection');
                if (!transactionSection.classList.contains('hidden')) {
                    displayTransactions();
                }
            }
        }

        function proceedToTransactionReview() {
    // Update categories
    updateCategories();

    // Apply category defaults to transactions
    transactions.forEach(transaction => {
        if (!transaction.manuallyEdited) {
            const categoryData = categories[transaction.category] || categories['Uncategorized (Default)'];
            if (categoryData) {
                transaction.partner1Percent = categoryData.partner1;
                transaction.partner2Percent = categoryData.partner2;
            }
        }
    });

    // Show the transaction section
    const transactionSection = document.getElementById('transactionSection');
    if (transactionSection) {
        transactionSection.classList.remove('hidden');
    }

    // Display transactions
    displayTransactions();

    // Scroll to section
    setTimeout(() => {
        if (transactionSection) {
            transactionSection.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }
    }, 200);
}

        function displayTransactions() {
            console.log('displayTransactions called');
            console.log('Transactions to display:', transactions);

            const expensesBody = document.getElementById('expensesBody');
            const creditsBody = document.getElementById('creditsBody');
            const noCreditsMessage = document.getElementById('noCreditsMessage');

            if (!expensesBody || !creditsBody) {
                console.error('Transaction table elements not found');
                return;
            }

            expensesBody.innerHTML = '';
            creditsBody.innerHTML = '';

            const partner1Name = document.getElementById('partner1').value || 'Partner 1';
            const partner2Name = document.getElementById('partner2').value || 'Partner 2';
            const partner1Possessive = partner1Name.endsWith('s') ? `${partner1Name}'` : `${partner1Name}'s`;
            const partner2Possessive = partner2Name.endsWith('s') ? `${partner2Name}'` : `${partner2Name}'s`;

            // Update headers for both tables
            updateTableHeaders('expensesTable', partner1Possessive, partner2Possessive);
            updateTableHeaders('creditsTable', partner1Possessive, partner2Possessive);

            // Separate transactions into expenses and credits, excluding credit card payments
            const expenses = [];
            const credits = [];

            transactions.forEach((transaction, index) => {
                // Skip credit card payments entirely
                if (isCreditCardBillPayment(transaction.description)) {
                    return;
                }

                if (transaction.amount >= 0) {
                    expenses.push({ transaction, originalIndex: index });
                } else {
                    credits.push({ transaction, originalIndex: index });
                }
            });

            // Populate expenses table
            expenses.forEach(({ transaction, originalIndex }) => {
                expensesBody.appendChild(createTransactionRow(transaction, originalIndex));
            });

            // Filter out any remaining bill payments from credits and populate credits table
            const filteredCredits = credits.filter(({ transaction }) => {
                return !isCreditCardBillPayment(transaction.description);
            });

            if (filteredCredits.length > 0) {
                filteredCredits.forEach(({ transaction, originalIndex }) => {
                    creditsBody.appendChild(createTransactionRow(transaction, originalIndex));
                });
                noCreditsMessage.style.display = 'none';
            } else {
                noCreditsMessage.innerHTML = 'No credits or refunds found in this statement.';
                noCreditsMessage.style.display = 'block';
            }

            function proceedToTransactionReview() {
                updateCategories();

                transactions.forEach(transaction => {
                    if (!transaction.manuallyEdited) {
                        const categoryData = categories[transaction.category] || categories['Uncategorized (Default)'];
                        transaction.partner1Percent = categoryData.partner1;
                        transaction.partner2Percent = categoryData.partner2;
                    }
                });

                displayTransactions();

                // Always scroll when the button is clicked
                setTimeout(() => {
                    scrollToSection('transactionSection');
                }, 100);
            }
        }
        function updateTableHeaders(tableId, partner1Possessive, partner2Possessive) {
            const headerRow = document.querySelector(`#${tableId} thead tr`);
            if (headerRow) {
                const headers = headerRow.querySelectorAll('th');
                if (headers.length >= 7) {
                    headers[4].textContent = `${partner1Possessive} %`;
                    headers[5].textContent = `${partner1Possessive} Amount`;
                    headers[6].textContent = `${partner2Possessive} Amount`;
                }
            }
        }

        function createTransactionRow(transaction, index) {
            const partner1Amount = (transaction.amount * transaction.partner1Percent) / 100;
            const partner2Amount = (transaction.amount * transaction.partner2Percent) / 100;

            const isUncategorized = transaction.category === 'Uncategorized (Default)' ||
                transaction.category === 'Uncategorized' ||
                (transaction.category && transaction.category.toLowerCase().includes('uncategorized'));

            // Check for partial vendor matches
            const hasPartialMatch = checkForPartialVendorMatch(transaction, index);

            // Determine the CSS class for the category select
            let categorySelectClass = 'category-select';
            if (isUncategorized) {
                categorySelectClass += ' uncategorized-category';
            } else if (hasPartialMatch) {
                categorySelectClass += ' partial-match-category';
            }

            const row = document.createElement('tr');
            row.innerHTML = `
    <td>${transaction.date}</td>
    <td>${transaction.description}</td>
    <td>
        <select class="${categorySelectClass}" 
                onchange="updateTransactionCategory(${index}, this.value)">
            ${Object.keys(categories).map(cat =>
                `<option value="${cat}" ${transaction.category === cat ? 'selected' : ''}>${cat}</option>`
            ).join('')}
        </select>
    </td>
    <td>
        ${transaction.amount >= 0 ? '$' + transaction.amount.toFixed(2) : '-$' + Math.abs(transaction.amount).toFixed(2)}
        </td>
    <td>
        <input type="number" class="percent-input editable-field" value="${transaction.partner1Percent}" 
               onchange="updateTransactionPercent(${index}, 1, this.value)" min="0" max="100">
    </td>
    <td>
        <input type="number" class="amount-input editable-field" value="${Math.abs(partner1Amount).toFixed(2)}" 
               onchange="updatePartnerAmount(${index}, 1, this.value)" step="0.01">
    </td>
    <td class="readonly-amount">${partner2Amount >= 0 ? '$' + partner2Amount.toFixed(2) : '-$' + Math.abs(partner2Amount).toFixed(2)}</td>
    <td style="text-align: center;">
        <button type="button" class="delete-btn" onclick="deleteTransaction(${index})">&times;</button>
    </td>
`;
            return row;
        }

        function checkForPartialVendorMatch(currentTransaction, currentIndex) {
            const currentNormalized = normalizeVendorName(currentTransaction.description);

            for (let i = 0; i < transactions.length; i++) {
                if (i === currentIndex) continue;

                const otherTransaction = transactions[i];
                const otherNormalized = normalizeVendorName(otherTransaction.description);

                if (currentNormalized === otherNormalized &&
                    currentTransaction.category !== otherTransaction.category &&
                    !currentTransaction.category.toLowerCase().includes('uncategorized') &&
                    !otherTransaction.category.toLowerCase().includes('uncategorized')) {
                    return true;
                }
            }

            return false;
        }
        function isCreditCardBillPayment(description) {
            const desc = description.toLowerCase().trim();

            // Common bill payment patterns
            const billPaymentPatterns = [
                // Direct payment terms
                'autopay payment',
                'automatic payment',
                'online payment',
                'bill payment',
                'payment received',
                'payment - thank you',
                'payment thank you',
                'thank you for your payment',

                // Payment method indicators
                'ach payment',
                'electronic payment',
                'bank transfer payment',
                'direct debit',
                'auto debit',

                // Credit card company specific
                'chase autopay',
                'citi autopay',
                'amex autopay',
                'discover autopay',
                'capital one autopay',
                'wells fargo autopay',
                'bank of america autopay',
                'usaa autopay',

                // General payment confirmations
                'payment processed',
                'payment confirmation',
                'balance payment',
                'statement payment',
                'account payment',
                'credit payment',
                'payment credit',

                // Thank you messages
                'thank you',
                'thanks for your payment',
                'payment appreciated'
            ];

            // Check if description contains any bill payment patterns
            return billPaymentPatterns.some(pattern => desc.includes(pattern));
        }
        function updateTransactionCategory(index, category) {
            // Set flag to indicate this is a manual update
            isManualCategoryUpdate = true;

            const oldCategory = transactions[index].category;
            const vendor = transactions[index].description;

            // Update the current transaction
            transactions[index].category = category;
            transactions[index].manuallyEdited = false;

            // Apply category defaults when category is changed
            const categoryData = categories[category];
            if (categoryData) {
                transactions[index].partner1Percent = categoryData.partner1;
                transactions[index].partner2Percent = categoryData.partner2;
            }

            // Find and update all other transactions from the same vendor
            const sameVendorTransactions = [];
            const normalizedVendor = normalizeVendorName(vendor);

            transactions.forEach((transaction, i) => {
                if (i !== index && normalizeVendorName(transaction.description) === normalizedVendor) {
                    if (!transaction.manuallyEdited) { // Only update if not manually edited
                        transaction.category = category;

                        // Apply category percentage defaults
                        if (categoryData) {
                            transaction.partner1Percent = categoryData.partner1;
                            transaction.partner2Percent = categoryData.partner2;
                        }

                        sameVendorTransactions.push(transaction);
                    }
                }
            });

            // Show success message if we updated other transactions
            if (sameVendorTransactions.length > 0) {
                showBulkUpdateMessage(sameVendorTransactions.length, getDisplayVendorName(vendor), category);
            }

            // Refresh the display without auto-scroll
            displayTransactions();

            // Reset the flag
            isManualCategoryUpdate = false;
        }

        function normalizeVendorName(description) {
            // Normalize vendor names for matching
            return description
                .toLowerCase()
                .trim()
                // Remove common suffixes and prefixes
                .replace(/\s*(inc|llc|corp|ltd|co|company)\s*$/i, '')
                .replace(/^(the\s+)/i, '')
                // Remove location indicators
                .replace(/\s*#\d+.*$/, '') // Remove store numbers like "#123"
                .replace(/\s*-\s*\w+\s*\w*$/, '') // Remove location suffixes like "- Downtown"
                .replace(/\s*\d{4,}.*$/, '') // Remove long numbers (like store IDs)
                // Remove payment method indicators
                .replace(/\s*(visa|mastercard|amex|discover|debit|credit).*$/i, '')
                // Remove common transaction codes
                .replace(/\s*pos\s*\d*.*$/i, '')
                .replace(/\s*ref\s*#.*$/i, '')
                .replace(/\s*auth\s*#.*$/i, '')
                // Clean up extra spaces
                .replace(/\s+/g, ' ')
                .trim();
        }

        function getDisplayVendorName(description) {
            // Get a clean display name for the vendor
            const normalized = description
                .trim()
                // Remove store numbers and location info
                .replace(/\s*#\d+.*$/, '')
                .replace(/\s*-\s*\w+\s*\w*$/, '')
                .replace(/\s*\d{4,}.*$/, '')
                // Remove payment method indicators
                .replace(/\s*(visa|mastercard|amex|discover|debit|credit).*$/i, '')
                // Remove transaction codes
                .replace(/\s*pos\s*\d*.*$/i, '')
                .replace(/\s*ref\s*#.*$/i, '')
                .replace(/\s*auth\s*#.*$/i, '')
                // Clean up
                .replace(/\s+/g, ' ')
                .trim();

            // Capitalize first letter of each word
            return normalized.replace(/\b\w/g, l => l.toUpperCase());
        }

        function showBulkUpdateMessage(count, vendorName, category) {
            // Remove any existing message
            const existingMessage = document.getElementById('bulk-update-message');
            if (existingMessage) existingMessage.remove();

            // Create success message
            const message = document.createElement('div');
            message.id = 'bulk-update-message';
            message.style.cssText = `
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 8px;
        padding: 12px 20px;
        margin: 15px 0;
        color: #155724;
        font-size: 14px;
        text-align: center;
        animation: slideIn 0.3s ease-out;
        position: relative;
    `;

            message.innerHTML = `
        âœ… <strong>Bulk Update Applied!</strong> Updated ${count} transaction(s) from "${vendorName}" to "${category}" category.
        <button onclick="this.parentElement.remove()" style="position: absolute; right: 10px; top: 8px; background: none; border: none; color: #155724; font-size: 16px; cursor: pointer; padding: 2px 6px;">&times;</button>
    `;

            // Insert after the expenses table
            const expensesTable = document.getElementById('expensesTable');
            if (expensesTable) {
                expensesTable.insertAdjacentElement('afterend', message);
            }

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (message.parentElement) {
                    message.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => message.remove(), 300);
                }
            }, 5000);
        }

        // Add CSS animation for the success message
        function addBulkUpdateStyles() {
            if (!document.getElementById('bulk-update-styles')) {
                const style = document.createElement('style');
                style.id = 'bulk-update-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { opacity: 0; transform: translateY(-10px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Initialize the styles when the page loads
        document.addEventListener('DOMContentLoaded', function () {
            setupFileUpload();
            setupPartnerNameUpdates();
            addBulkUpdateStyles();
        });

        function updateTransactionCategoryDropdowns() {
            const transactionSection = document.getElementById('transactionSection');
            if (transactionSection.classList.contains('hidden')) {
                return;
            }

            const categorySelects = document.querySelectorAll('.category-select');

            categorySelects.forEach((select, index) => {
                const currentValue = select.value;
                const categoryStillExists = Object.keys(categories).includes(currentValue);

                select.innerHTML = '';

                Object.keys(categories).forEach(categoryName => {
                    const option = document.createElement('option');
                    option.value = categoryName;
                    option.textContent = categoryName;
                    select.appendChild(option);
                });

                if (categoryStillExists) {
                    select.value = currentValue;
                } else {
                    select.value = 'Uncategorized (Default)';
                    // Note: We don't update transactions here as the display will refresh
                }
            });

            displayTransactions();
        }

        function updatePartnerAmount(index, partner, amount) {
            isManualCategoryUpdate = true; // Prevent auto-scroll

            const newAmount = parseFloat(amount) || 0;
            const totalAmount = transactions[index].amount;

            if (newAmount > totalAmount) {
                displayTransactions();
                isManualCategoryUpdate = false;
                return;
            }

            if (partner === 1) {
                const newPercent = (newAmount / totalAmount) * 100;
                transactions[index].partner1Percent = Math.round(newPercent);
                transactions[index].partner2Percent = 100 - transactions[index].partner1Percent;
                transactions[index].manuallyEdited = true;
                displayTransactions();
            }

            isManualCategoryUpdate = false; // Reset flag
        }

        function updateTransactionPercent(index, partner, percent) {
            isManualCategoryUpdate = true; // Prevent auto-scroll

            const percentValue = Math.round(parseFloat(percent) || 0);

            if (partner === 1) {
                transactions[index].partner1Percent = percentValue;
                transactions[index].partner2Percent = 100 - percentValue;
                transactions[index].manuallyEdited = true;
                displayTransactions();
            }

            isManualCategoryUpdate = false; // Reset flag
        }

        function deleteTransaction(index) {
            isManualCategoryUpdate = true; // Prevent auto-scroll

            transactions.splice(index, 1);
            displayTransactions();

            isManualCategoryUpdate = false; // Reset flag
        }

        function calculateSplit() {
            updateCategories();

            let partner1Total = 0;
            let partner2Total = 0;
            let totalAmount = 0;
            const categoryBreakdown = {};

            // Filter out credit card payments and calculate totals
            transactions.forEach(transaction => {
                // Skip credit card bill payments entirely
                if (isCreditCardBillPayment(transaction.description)) {
                    return;
                }

                const partner1Share = (transaction.amount * transaction.partner1Percent) / 100;
                const partner2Share = (transaction.amount * transaction.partner2Percent) / 100;

                partner1Total += partner1Share;
                partner2Total += partner2Share;
                totalAmount += transaction.amount;

                // Track category totals (excluding credit card payments)
                if (!categoryBreakdown[transaction.category]) {
                    categoryBreakdown[transaction.category] = {
                        total: 0,
                        partner1: 0,
                        partner2: 0
                    };
                }
                categoryBreakdown[transaction.category].total += transaction.amount;
                categoryBreakdown[transaction.category].partner1 += partner1Share;
                categoryBreakdown[transaction.category].partner2 += partner2Share;
            });

            const partner1Name = document.getElementById('partner1').value || 'Partner 1';
            const partner2Name = document.getElementById('partner2').value || 'Partner 2';

            // Update summary cards
            document.getElementById('partner1Summary').textContent = partner1Name;
            document.getElementById('partner2Summary').textContent = partner2Name;
            document.getElementById('partner1Amount').textContent = `$${partner1Total.toFixed(2)}`;
            document.getElementById('partner2Amount').textContent = `$${partner2Total.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `$${totalAmount.toFixed(2)}`;

            // Update summary table headers
            document.getElementById('partner1SummaryHeader').textContent = partner1Name;
            document.getElementById('partner2SummaryHeader').textContent = partner2Name;

            // Populate detailed breakdown table
            populateSummaryTable(categoryBreakdown, totalAmount, partner1Total, partner2Total);

            document.getElementById('summarySection').classList.remove('hidden');

            if (!isManualCategoryUpdate) {
                setTimeout(() => {
                    scrollToSection('summarySection');
                }, 100);
            }
        }
        function markSectionCompleted(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('completed');
            }
        }
        function populateSummaryTable(categoryBreakdown, totalAmount, partner1Total, partner2Total) {
            const tbody = document.getElementById('summaryTableBody');
            tbody.innerHTML = '';

            // Sort categories by absolute total amount (highest first)
            const sortedCategories = Object.entries(categoryBreakdown)
                .sort(([, a], [, b]) => Math.abs(b.total) - Math.abs(a.total));

            sortedCategories.forEach(([category, data]) => {
                // Calculate percentage based on absolute values to avoid negative percentages
                const percentage = totalAmount !== 0 ? ((Math.abs(data.total) / Math.abs(totalAmount)) * 100).toFixed(1) : '0.0';

                const row = document.createElement('tr');
                row.innerHTML = `
            <td><strong>${category}</strong></td>
            <td>$${data.total.toFixed(2)}</td>
            <td>${percentage}%</td>
            <td>$${data.partner1.toFixed(2)}</td>
            <td>$${data.partner2.toFixed(2)}</td>
        `;
                tbody.appendChild(row);
            });

            // Update totals row
            document.getElementById('summaryTotalAmount').innerHTML = `<strong>$${totalAmount.toFixed(2)}</strong>`;
            document.getElementById('summaryPartner1Total').innerHTML = `<strong>$${partner1Total.toFixed(2)}</strong>`;
            document.getElementById('summaryPartner2Total').innerHTML = `<strong>$${partner2Total.toFixed(2)}</strong>`;
        }
        function exportCompleteReport() {
            if (!transactions || transactions.length === 0) {
                alert('No transactions to export. Please upload a CSV file and review transactions first.');
                return;
            }

            const partner1Name = document.getElementById('partner1').value || 'Partner 1';
            const partner2Name = document.getElementById('partner2').value || 'Partner 2';

            let partner1Total = 0;
            let partner2Total = 0;
            let totalAmount = 0;
            const categoryTotals = {};

            // Filter out credit card payments for the financial calculations
            const financialTransactions = transactions.filter(transaction =>
                !isCreditCardBillPayment(transaction.description)
            );

            financialTransactions.forEach(transaction => {
                const partner1Share = (transaction.amount * transaction.partner1Percent) / 100;
                const partner2Share = (transaction.amount * transaction.partner2Percent) / 100;

                partner1Total += partner1Share;
                partner2Total += partner2Share;
                totalAmount += transaction.amount;

                if (!categoryTotals[transaction.category]) {
                    categoryTotals[transaction.category] = 0;
                }
                categoryTotals[transaction.category] += transaction.amount;
            });

            let csv = `Couples Finance Split - Complete Report\n`;
            csv += `Generated on: ${new Date().toLocaleDateString()}\n\n`;

            csv += `FINANCIAL SUMMARY (Excluding Credit Card Payments)\n`;
            csv += `===================\n`;
            csv += `Partner,Amount Owed\n`;
            csv += `${partner1Name},${partner1Total.toFixed(2)}\n`;
            csv += `${partner2Name},${partner2Total.toFixed(2)}\n`;
            csv += `Total Expenses,${totalAmount.toFixed(2)}\n\n`;

            csv += `REIMBURSEMENT\n`;
            if (partner1Total > partner2Total) {
                const difference = partner1Total - partner2Total;
                csv += `${partner2Name} owes ${partner1Name},${difference.toFixed(2)}\n`;
            } else if (partner2Total > partner1Total) {
                const difference = partner2Total - partner1Total;
                csv += `${partner1Name} owes ${partner2Name},${difference.toFixed(2)}\n`;
            } else {
                csv += `No reimbursement needed,Expenses are exactly split\n`;
            }
            csv += `\n`;

            csv += `SPENDING BY CATEGORY (Excluding Credit Card Payments)\n`;
            csv += `Category,Total Amount,Percentage of Total\n`;
            Object.entries(categoryTotals)
                .sort(([, a], [, b]) => b - a)
                .forEach(([category, amount]) => {
                    const percentage = ((amount / totalAmount) * 100).toFixed(1);
                    csv += `${category},${amount.toFixed(2)},${percentage}%\n`;
                });

            csv += `\n\n`;

            csv += `TRANSACTION DETAILS (Excluding Credit Card Payments)\n`;
            csv += `====================\n`;
            csv += `Date,Vendor,Category,Total Amount,${partner1Name} %,${partner2Name} %,${partner1Name} Amount,${partner2Name} Amount\n`;

            financialTransactions.forEach(transaction => {
                const partner1Amount = (transaction.amount * transaction.partner1Percent) / 100;
                const partner2Amount = (transaction.amount * transaction.partner2Percent) / 100;

                const description = transaction.description.includes(',')
                    ? `"${transaction.description}"`
                    : transaction.description;

                csv += `${transaction.date},${description},${transaction.category},${transaction.amount.toFixed(2)},${transaction.partner1Percent}%,${transaction.partner2Percent}%,${partner1Amount.toFixed(2)},${partner2Amount.toFixed(2)}\n`;
            });

            const currentDate = new Date().toISOString().split('T')[0];
            const filename = `couples-finance-report-${currentDate}.csv`;

            downloadCSV(csv, filename);
        }

        function downloadCSV(csvContent, filename) {
            try {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';

                document.body.appendChild(link);
                link.click();

                setTimeout(() => {
                    if (document.body.contains(link)) {
                        document.body.removeChild(link);
                    }
                    URL.revokeObjectURL(url);
                }, 100);

                alert('Export successful! File downloaded: ' + filename);
            } catch (error) {
                alert('Download failed. Please try again.');
            }
        }
    </script>
</body>

</html>